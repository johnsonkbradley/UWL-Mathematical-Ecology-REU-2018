---
title: "R Notebook"
output: html_notebook
---

Libraries
===

```{r}
library(dplyr)
library(ggplot2)
library(ggmap)
library(car)
library(GGally)
library(lubridate)
library(cluster)
library(factoextra)
##pulling from api packages
library(rtweet)
library(httr)
library(jsonlite)
```

Load in the keys
===

```{r}
##flickr keys
keys <- read.table("flickrAPIkeys.txt", sep = ",", header = T) #have key and secret
##twitter keys
twitterKeys <- read.table("twitterAPIkeys.txt", sep = ",", header = T)
twitterKeys$consumer_key <- as.character(twitterKeys$consumer_key)
twitterKeys$consumer_secret <- as.character(twitterKeys$consumer_secret)
twitterKeys$access_token <- as.character(twitterKeys$access_token)
twitterKeys$access_secret <- as.character(twitterKeys$access_secret)
```

Flickr functions
===

```{r}
## This function will give you all of the flickr photos for a given query, starting from a certain date that the photos were taken
## Inputs: the search query you want, the earliest day you want to grab that a photo was taken on
## OUtputs: all flickr posts matching the qeury and the minimum photo taken date that you specified
GetPhotos <- function(query, startDate) {
  query <- gsub(" ", "+", query)
  startDate <- gsub("/", "%2F", startDate)
  url <- paste("https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key=",keys$key,"&text=",query,"&min_taken_date=",startDate,"&sort=date-taken-asc&content_type=1&per_page=5000&format=json&nojsoncallback=1&api_sig=",keys$secret, sep = "")
  photos <- GET(url = url)%>%content(as = "text")%>%fromJSON()
  photosDF <- photos$'photos'$photo
  return(photosDF)
}


## This function will give you all of the flickr photos for a given query, starting from a certain date that the photos were taken within a certain bounding box
## Inputs: the search query you want, the earliest day you want to grab that a photo was taken on, along with the bounding box of the area you want, comma seperated minlong, minlat, maxlong, maxlat
## OUtputs: all flickr posts matching the qeury and the minimum photo taken date that you specified
GetPhotosBBox <- function(query, startDate, bbox) {
  query <- gsub(" ", "+", query)
  startDate <- gsub("/", "%2F", startDate)
  url <- paste("https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key=",keys$key,"&text=",query,"&min_taken_date=",startDate,"&bbox=",bbox,"&sort=date-taken-asc&content_type=1&per_page=5000&format=json&nojsoncallback=1&api_sig=",keys$secret, sep = "")
  photos <- GET(url = url)%>%content(as = "text")%>%fromJSON()
  photosDF <- photos$'photos'$photo
  return(photosDF)
}

## This function will return the date that a flickr photo was taken, given the id number of the picture
## Inputs: the id number of the picture you want to know the date taken
## Outputs: the date taken
GetDate <- function(id) {
  url <- paste("https://api.flickr.com/services/rest/?method=flickr.photos.getInfo&api_key=",keys$key,"&photo_id=",id,"&format=json&nojsoncallback=1&api_sig=",keys$secret, sep = "")
  info <- GET(url = url)%>%content(as = "text")%>%fromJSON()
  date <- info$`photo`$dates$taken
  return(date)
}
```

Setting up the Twitter Token (so we can use the API)
===

```{r}
create_token(app = "REU 2018", consumer_key = twitterKeys$consumer_key, consumer_secret =  twitterKeys$consumer_secret, access_token = twitterKeys$access_token, access_secret = twitterKeys$access_secret)
```

How to search using rtweets (test)
===

```{r}
mendota1 <- search_tweets(q = "Lake Mendota")
ts_plot(mendota1) ##we can see the number of tweets per time; ggplot style; 9 day cap for pulls
mendota1 ##this is saved as a list, so we cant save in a csv file to send save as an rda file


waubesa1 <- search_tweets(q = "Lake Waubesa")
ts_plot(waubesa1)
waubesa1

shawano1 <- search_tweets(q = "Shawano Lake")
ts_plot(shawano1)
shawano1

druid1 <- search_tweets(q = "Druid Lake")
ts_plot(druid1)
druid1

hatch1 <- search_tweets(q = "Hatch Lake")
ts_plot(hatch1)
hatch1

squash1 <- search_tweets(q = "Squash Lake")
ts_plot(squash1)
squash1

mcgee1 <- search_tweets(q = "McGee Lake")
ts_plot(mcgee1)
mcgee1

tabor1 <- search_tweets(q = "Tabor Lake")
ts_plot(tabor1)
tabor1

##saving as an rda file
save(mendota1, file = "mendota6.20.2018.rda")
save(waubesa1, file = "waubesa6.26.2018.rda")
save(shawano1, file = "shawano6.26.2018.rda")
save(druid1, file = "druid6.26.2018.rda")
save(hatch1, file = "hatch6.26.2018.rda")
save(squash1, file = "squash.6.26.2018.rda")
save(mcgee1, file = "mcgee6.26.2018.rda")
save(tabor1, file = "tabor6.26.2018.rda")
```


Flickr function to get Visitors per year
===

```{r}
## This function will give us the average number of visitors per year based on a data frame of flickr photos
## Inputs: a data frame of flickr photos
## Outputs: the number of visitors per year for a lake
FlickrVPY <- function(dataFlickr5) {
  dataFlickr5$Year <- substr(dataFlickr5$DateTaken, 1, 4)
  dataFlickr5$Month <- substr(dataFlickr5$DateTaken, 6, 7)
  dataFlickr5$Day <- substr(dataFlickr5$DateTaken, 9, 10)

  dataUnique <- dataFlickr5%>%group_by(owner, Year, Month, Day)%>%summarise(Count = n())

  dataVPY <- dataUnique%>%group_by(Year)%>%summarise(Count = n())
  
  dataVPY <- dataVPY %>% filter(Year != "2018")
  meanVPY <- mean(dataVPY$Count)
  return(meanVPY)
}
```


*need to use the bbox for everything on flickr*
