---
title: "R Notebook"
output: html_notebook
---

Get the Flickr data for Devil's Lake
===

```{r}
devilsFlickr5 <- GetPhotosBBox(query = "", startDate = "3/10/2018", bbox = "-89.772087,43.384152,-89.682693,43.43512")
dim(devilsFlickr5)
devilsFlickr5$DateTaken <- sapply(devilsFlickr5$id, GetDate)
devilsFlickr5

#devils1.1.13_9.13.14 <- devilsFlickr5
#devils9.14.14_10.25.15 <- devilsFlickr5
#devils10.26.15_9.4.16 <- devilsFlickr5
#devils9.5.16_3.9.18 <- devilsFlickr5
#devils3.10.18_6.23.18 <- devilsFlickr5

devilsFlickr5 <- rbind(devils1.1.13_9.13.14, devils9.14.14_10.25.15, devils10.26.15_9.4.16, devils9.5.16_3.9.18, devils3.10.18_6.23.18)

devilsFlickr5$Name <- "Devil's Lake, WI"
```

Get the Unique, Month, and Year stats for Devil's Lake
===

```{r}
devilsFlickr5$Year <- substr(devilsFlickr5$DateTaken, 1, 4)
devilsFlickr5$Month <- substr(devilsFlickr5$DateTaken, 6, 7)
devilsFlickr5$Day <- substr(devilsFlickr5$DateTaken, 9, 10)

devilsUnique <- devilsFlickr5%>%group_by(owner, Year, Month, Day)%>%summarise(Count = n())
dim(devilsUnique)## 216 unique visitor days

devilsMonth <- devilsUnique%>%group_by(Year, Month)%>%summarise(Count = n())
devilsMonth$Date <- paste(devilsMonth$Year, devilsMonth$Month, sep = "-")
devilsMonth$Group = 1
devilsMonth

##Plot
ggplot(data = devilsMonth, aes(x = Date, y = Count, group = Group)) + geom_line() + theme(axis.text.x = element_text(angle = 90))
```

Reconfigure the devilsMonth data set to make the rows with months that had 0 flickr posts
===

```{r}
DATES <- data.frame(Month = c(rep(c("01", "02", "03", "04", "05", "06","07", "08", "09", "10", "11", "12"), 5), "01", "02", "03", "04", "05", "06"), Year = c(rep("2013", 12), rep("2014", 12), rep("2015", 12), rep("2016", 12), rep("2017", 12), rep("2018", 6)))
DATES$Date <- paste(DATES$Year, DATES$Month, sep = "-")
DATES

devilsMonth2 <- DATES%>%left_join(devilsMonth[,-c(1,2)], by = "Date")
devilsMonth2$Count[is.na(devilsMonth2$Count)] <- 0
devilsMonth2$Group <- 1
devilsMonth2

##Plot
ggplot(data = devilsMonth2, aes(x = Date, y = Count, group = Group, col = Year)) +
  geom_line(size = 2) +
  theme_bw() +
  scale_x_discrete(labels = c(rep(c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), 5), "Jan", "Feb", "Mar", "Apr", "May", "Jun")) +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_color_manual(values = c("red", "orange", "gold", "green", "blue", "purple")) +
  xlab("Month") +
  ylab("Number of Flickr Visitors") +
  ggtitle("Devil's Lake Lake Flickr Visitors Per Month") + 
  geom_smooth(se = F, method = "lm", col = "black")
```

Devil's Lake Gage Height and Precipitation
===

### Gage Height

```{r}
devilsGage <- read.table("https://nwis.waterdata.usgs.gov/usa/nwis/uv/?cb_00065=on&format=rdb&site_no=05404500&period=&begin_date=2013-01-01&end_date=2018-07-05", skip = 31, sep = "\t")
dim(devilsGage)
colnames(devilsGage) <- c("Agency", "Code", "Time", "TimeZone", "GageHeight", "A")
devilsGage$Time <- as.character(devilsGage$Time)
devilsGage$Year <- substr(devilsGage$Time, 1, 4)
devilsGage$Month <- substr(devilsGage$Time, 6, 7)
devilsGage$Day <- substr(devilsGage$Time, 9, 10)

devilsGage <- devilsGage%>%group_by(Year, Month, Day)%>%summarise(AvgGageHeight = mean(GageHeight))
devilsGage
```

### Precipitation

```{r}
devilsPrecip <- read.table("https://nwis.waterdata.usgs.gov/usa/nwis/uv/?cb_00045=on&format=rdb&site_no=05404500&period=&begin_date=2013-01-01&end_date=2018-07-05", skip = 31, sep = "\t")
dim(devilsPrecip)
colnames(devilsPrecip) <- c("Agency", "Code", "Time", "TimeZone", "Precipitation", "A")
devilsPrecip$Time <- as.character(devilsPrecip$Time)
devilsPrecip$Year <- substr(devilsPrecip$Time, 1, 4)
devilsPrecip$Month <- substr(devilsPrecip$Time, 6, 7)
devilsPrecip$Day <- substr(devilsPrecip$Time, 9, 10)

devilsPrecip <- devilsPrecip%>%group_by(Year, Month, Day)%>%summarise(TotalPrecip = sum(Precipitation))
devilsPrecip
```

Combining the gage height and precipitation
===

```{r}
devilsData <- devilsGage%>%left_join(devilsPrecip, by = c("Year", "Month", "Day"))
devilsData

devilsDataMonthly <- devilsData%>%group_by(Year, Month)%>%summarise(AvgGageHeight = mean(AvgGageHeight), TotalPrecip = sum(TotalPrecip))
devilsDataMonthly$Date <- paste(devilsDataMonthly$Year, devilsDataMonthly$Month, sep = "-")
devilsDataMonthly$Group = 1
devilsDataMonthly

## Plot
ggplot() +
  geom_line(data = devilsMonth2, aes(x = Date, y = Count, group = Group), col = "black" ,size = 2) +
  geom_line(data = devilsMonth2, aes(x = Date, y = log(Visitors), group = Group), col = "blue", size = 2) +
  geom_vline(aes(xintercept = which(devilsDataMonthly$Date %in% c("2018-06", "2017-06", "2016-06", "2014-06"))), col = "green", lty = 2, size = 2) +
  geom_vline(aes(xintercept = which(devilsDataMonthly$Date %in% c("2013-06", "2015-06"))), col = "grey", lty = 2, size = 2) +
  theme_bw() +
  scale_x_discrete(labels = c(rep(c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"), 5), "Jan", "Feb", "Mar", "Apr", "May", "Jun")) +
  theme(axis.text.x = element_text(angle = 90)) +
  xlab("Month") +
  ylab("Measure") +
  ggtitle("Devil's Lake Stats")
```

Devil's Lake Time Series
===

```{r}
devilsTS <- ts(devilsMonth2$Count, start = c(2013,1), end = c(2018,6), frequency = 12)
plot(devilsTS)
devilsDECOMPSE <- decompose(devilsTS)
plot(devilsDECOMPSE)
devilsRandom <- devilsDECOMPSE$random
devilsRandom <- as.vector(devilsRandom)
devilsRandom
devilsRamdonDF <- data.frame(Date = devilsMonth2$Date, Count = devilsRandom)
devilsRamdonDF$SwimItch <- devilsRamdonDF$Date %in% c("2018-06", "2017-06", "2016-06", "2014-06")
devilsRamdonDF$SwimItchLag <- devilsRamdonDF$Date %in% c("2018-07", "2017-07", "2016-07", "2014-07")
devilsRamdonDF

## random (residual) model
devilsMod1 <- lm(Count ~ SwimItch + SwimItchLag, data = devilsRamdonDF)
summary(devilsMod1) ## not significant
anova(devilsMod1)

##neither are significant
t.test(Count ~ SwimItch, data = devilsRamdonDF)
t.test(Count ~ SwimItchLag, data = devilsRamdonDF)
```

Actual visitor count
===

```{r}
devilsActual <- read.csv("devilsLakeVisitors.csv", header = T)
devilsActual$Year <- as.character(devilsActual$Year)
devilsActual$Month <- as.character(devilsActual$Month)

for (i in 1:nrow(devilsActual)) {
  if (nchar(devilsActual$Month[i]) == 1) {
    devilsActual$Month[i] <- paste("0", devilsActual$Month[i], sep = "")
  }
}

devilsActual
```

Merge the actual counts with oir flickr visitors
===

```{r}
devilsMonth2 <- devilsMonth2%>%left_join(devilsActual, by = c("Year", "Month"))
devilsMonth2$Dist <- 3.69
cor.test(log(devilsMonth2$Count + 1), log(devilsMonth2$Visitors)) ## 0.497

summary(lm(log(Count + 1) ~ log(Visitors), data = devilsMonth2)) ##like Wood et al 2013
##beta = .40604, p < .001, adjR2 = 0.4538
summary(lm(Visitors ~ Count, data = devilsMonth2)) ## 30,778 per flickr visitor

ggplot(data = devilsMonth2, aes(x = log(Count), y = log(Visitors))) + geom_point() +
  geom_smooth(method = "lm", se = F, col = "red") +
  theme_bw() +
  ylim(values = c(0,14)) +
  geom_abline(intercept = 0, slope = 1, col = "lightgrey") +
  xlab("Log Number of Flickr Visitors per Month") +
  ylab("Log Number of Actual Visitors per Month") +
  ggtitle("Devil's Lake Actual Visitors vs Flickr Visitors")
```


Wisconsin State Parks Flickr vs Actual visitors
===

### merge all 10 state parks together

```{r}
stateParks <- rbind(devilsMonth2, dodgeMonth, kegonsaMonth, yellowstoneMonth, bigfootMonth, mirrorMonth, penninsulaMonth, pattisonMonth, buckhornMonth, perrotMonth)

##graph
ggplot(data = stateParks, aes(x = log(Count), y = log(Visitors))) + geom_point() +
  geom_smooth(method = "lm", se = F, col = "red") +
  theme_bw() +
  ylim(values = c(0,14)) +
  geom_abline(intercept = 0, slope = 1, col = "lightgrey") +
  xlab("Log Number of Flickr Visitors per Month") +
  ylab("Log Number of Actual Visitors per Month") +
  ggtitle("Wisconsin State Parks Actual Visitors vs Flickr Visitors")

##model
stateMod <- lm(log(Count + 1) ~ log(Visitors), data = stateParks)
summary(stateMod)
##beta = 0.27899, p < 0.001, adjR2 = 0.3682

##model with distances
stateModDist <- lm(log(Count + 1) ~ log(Visitors) * Dist, data = stateParks)
summary(stateModDist)
```

Merging all of the raw flickr5 data together to get the home location of the photo poster
===

```{r}
stateFlickr5 <- rbind(devilsFlickr5, dodgeFlickr5, kegonsaFlickr5, yellowstoneFlickr5, bigfootFlickr5, mirrorFlickr5, penninsulaFlickr5, pattisonFlickr5, buckhornFlickr5, perrotFlickr5)

dim(stateFlickr5)

stateFlickr5$Year <- substr(stateFlickr5$DateTaken, 1, 4)
stateFlickr5$Month <- substr(stateFlickr5$DateTaken, 6, 7)
stateFlickr5$Day <- substr(stateFlickr5$DateTaken, 9, 10)

stateUnique <- stateFlickr5%>%group_by(owner, Year, Month, Day, Name)%>%summarise(Count = n())
dim(stateUnique) ## 726 unique photo user days
stateUnique

stateUnique$Location <- sapply(stateUnique$owner, GetHomeLocation)
stateUnique$Location
nullList <- stateUnique$Location

for (i in 1:length(nullList)) {
  if (is.null(nullList[[i]])) {
    nullList[[i]] <- ""
  }
}
length(nullList)
nullList <- do.call(c, nullList)
stateUnique$Location <- nullList

stateUnique
```

gmapsdistance calculator
===

```{r}
gmapsdistance(origin = "Devil's+Lake+WI", destination = "", mode = "driving")$Distance / 1609

replacePattern <- "[[:punct:]]?\\s"
stateUnique$Name2 <- gsub(pattern = replacePattern, replacement = "+", x = stateUnique$Name)
stateUnique$Location2 <- gsub(pattern = replacePattern, replacement = "+", x = stateUnique$Location)

stateUnique$DistanceDriven <- NA
##will need to figure out how to get it so that we dont use the "" locations
for (i in 1:nrow(stateUnique)) {
  if (nchar(stateUnique$Location2[i]) > 1) {
    stateUnique$DistanceDriven[i] <- gmapsdistance(origin = stateUnique$Location2[i], destination = stateUnique$Name2[i], mode = "driving")$Distance / 1609
  }
}
stateUnique
```

Summarizing the distance results
===

```{r}
mean(stateUnique$DistanceDriven, na.rm = T) ##378.8918
median(stateUnique$DistanceDriven, na.rm = T) ##187.6209
parksDistances <- stateUnique%>%group_by(Name)%>%summarise(MeanDistance = mean(DistanceDriven, na.rm = T), 
                                                           MedianDistance = median(DistanceDriven, na.rm = T))
parksDistances

parksMelt <- melt(parksDistances)

ggplot(data = parksMelt, aes(x = Name, y = value, fill = variable)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_bw() +
  scale_fill_manual(values = c("darkblue", "lightblue"), name = "Measure") +
  xlab("State Park") +
  ylab("Driving Distance")

stateUnique%>%arrange(DistanceDriven)
hist(stateUnique$DistanceDriven, breaks = 100)
```

Filter down the state parks visitors to only legitimate distances
===

```{r}
stateFiltered <- stateUnique%>%filter(!is.na(DistanceDriven))
stateFiltered <- stateFiltered%>%filter(Location != "USA")
stateFiltered <- stateFiltered%>%filter(Location != "United States")
stateFiltered <- stateFiltered%>%filter(Location != "Wisconsin")
stateFiltered <- stateFiltered%>%filter(Location != "Fitchburg, USA")
stateFiltered <- stateFiltered%>%filter(Location != "same, USA" & Location != "The Universe, United States")
dim(stateFiltered)

ggplot(data = stateFiltered, aes(x = Name, y = DistanceDriven)) +
  geom_boxplot(fill = "grey") +
  theme_bw()

```

Computing days since the last visit to that park
===

```{r}
##create the right date format
stateFiltered$Date <- paste(stateFiltered$Day, stateFiltered$Month, stateFiltered$Year, sep = ".")

stateFiltered <- stateFiltered%>%arrange(Name, owner, Year, Month, Day)

##actually computing days since
stateFiltered$DaysSince <- NA
for (i in 2:nrow(stateFiltered)) {
  if((stateFiltered$owner[i] == stateFiltered$owner[i-1]) & (stateFiltered$Name[i] == stateFiltered$Name[i-1])) {
    stateFiltered$DaysSince[i] <- difftime(strptime(stateFiltered$Date[i], format = "%d.%m.%Y"),
                                           strptime(stateFiltered$Date[i-1], format = "%d.%m.%Y"), units = "days")
  }
}
stateFiltered

summary(stateFiltered$DaysSince)

ggplot(data = stateFiltered) + geom_point(aes(x = DistanceDriven, y = DaysSince), alpha = 0.5, size = 5) +
  geom_vline(xintercept = 50) + geom_hline(yintercept = 10) +ylim(limits=c(0,21)) + xlim(limits = c(0, 2600))


##going to filter on less than 10 days and over 50 miles
```

Get the length of trip for each visit
===

```{r}
stateFiltered$LengthTrip <- 0
stateFiltered$LengthTrip[stateFiltered$DistanceDriven > 50 & stateFiltered$DaysSince < 10 & !is.na(stateFiltered$DaysSince)] <- NA

for (i in 1:nrow(stateFiltered)) {
  if (is.na(stateFiltered$LengthTrip[i])) {
    next
  } else if (!is.na(stateFiltered$LengthTrip[i + 1])) {
    stateFiltered$LengthTrip[i] <- 1
  } else {
    j = i + 1
    while(j < nrow(stateFiltered) & is.na(stateFiltered$LengthTrip[j + 1])) {
      j = j +1
    }
    stateFiltered$LengthTrip[i] <- sum(stateFiltered$DaysSince[(i+1):j]) + 1
  }
}

stateFiltered

ggplot(data = stateFiltered) +
  theme_bw() +
  geom_point(aes(x = DistanceDriven, y = LengthTrip), alpha = 0.5, size = 2) +
  facet_wrap(~Name) +
  xlab("Distance Driven (miles)") +
  ylab("Length of Trip (days)")
```

Getting average stats for each state park
===

```{r}
filteredSummary <- stateFiltered%>%filter(!is.na(LengthTrip))%>%group_by(Name)%>%summarise(MeanDistance = mean(DistanceDriven, na.rm = T),
                                                                                           MedianDistance = median(DistanceDriven, na.rm = T),
                                                                                           MeanLengthTrip = mean(LengthTrip, na.rm = T),
                                                                                           MedianLengthTrip = median(LengthTrip, na.rm = T),
                                                                                           NumberOfVisits = n(),
                                                                                           NumberUniqueVisitors = n_distinct(owner))
filteredSummary
```



Plot these on a map of Wisconsin *re-do this once I re-summarize things*
===

```{r}
latLong <- read.csv("parks.csv", header = T)
latLong <- latLong%>%left_join(filteredSummary, by = c("Park" = "Name"))
latLong

##Mapping the state parks with there size according to the median distance traveled by Flickr users to the park
ggmap(wisconsin) +
  geom_point(data = latLong, aes(x = Long, y = Lat, size = MedianDistance, fill = (NumberUniqueVisitors / NumberOfVisits)), col = "black", shape = 21) +
  scale_size_continuous(range = c(3, 7), name = "Median Distance") +
  scale_fill_gradient(name = "Percent of Unique Visitors", low = "cyan", high = "darkblue") +
  xlim(limits = c(-93, -86)) +
  ylim(limits = c(42, 47)) +
  xlab("Longitude") +
  ylab("Latitude")
```


Weather (monthly) for all of the parks from Jan 2013 - June 2018
===

```{r}
devilsWeather <- read.csv("devilsLakeWeather.csv", header = T)
parksWeather <- read.csv("parksWeather.csv", header = T)
parksWeather <- rbind(parksWeather, devilsWeather)
parksWeather

ggplot(data = parksWeather,aes(x = DATE, y = PRCP, group = NAME, col = NAME)) + geom_line()
```

